# File need for CD
steps:
# Build the image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'europe-west2-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPOSITORY}/envoy:${_IMAGE_VERSION}', '-f', 'config/envoy_updated.Dockerfile', 'config/.']

# Push the image
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'europe-west2-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPOSITORY}/envoy:${_IMAGE_VERSION}']
# Build the image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'europe-west2-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPOSITORY}/grpc-server:${_IMAGE_VERSION}', 'agent-dialogue-core/.']

# Push the image
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'europe-west2-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REGISTRY_REPOSITORY}/grpc-server:${_IMAGE_VERSION}']

# deploy container image to GKE
# - name: "gcr.io/cloud-builders/gke-deploy"
#   args:
#   - run
#   - --filename=
#   - --location=${_CLUSTER_LOCATION}
#   - --cluster=${_CLUSTER_NAME}

- name: 'gcr.io/cloud-builders/kubectl'
  args:
  - apply
  - -f
  - config/${_K8_FILE}
  env:
  - CLOUDSDK_COMPUTE_REGION=${_CLUSTER_LOCATION}
  - CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}

substitutions:
  _ARTIFACT_REGISTRY_REPOSITORY: task-mad-images-repository 
  _IMAGE_VERSION: latest
  _K8_FILE: deployment-envoy.yaml
  _CLUSTER_LOCATION: europe-central2-a
  _CLUSTER_NAME: esp-core-cluster
  
# Timeout for 30 mins
timeout: 1800s